<div class="layuimini-container">
    <form id="app-form" class="layui-form layuimini-form">
        
        <div class="layui-form-item">
            <label class="layui-form-label">用户名</label>
            <div class="layui-input-block">
                <input type="text" name="username" class="layui-input" lay-verify="required" placeholder="请输入用户名" value="">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">密码</label>
            <div class="layui-input-block">
                <input type="password" name="password" class="layui-input" lay-verify="required" placeholder="请输入密码" value="">
                <div class="layui-form-mid layui-word-aux">密码长度建议6-20位</div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">软件版本</label>
            <div class="layui-input-block">
                <input type="text" name="soft_version" class="layui-input" lay-verify="required" placeholder="请输入软件版本" value="">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">窗口(允许数量)</label>
            <div class="layui-input-block">
                <input type="number" name="allow_window" class="layui-input" lay-verify="required|number" min="1" max="100" placeholder="请输入允许的窗口数量" value="1">
                <div class="layui-form-mid layui-word-aux">建议范围：1-100</div>
            </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">备注</label>
            <div class="layui-input-block">
                <textarea name="remark" class="layui-textarea"  placeholder="请输入备注"></textarea>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">API公钥</label>
            <div class="layui-input-block">
                <input type="text" name="api_public_key" class="layui-input" lay-verify="required" placeholder="请输入API公钥" value="">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">API私钥</label>
            <div class="layui-input-block">
                <input type="text" name="api_private_key" class="layui-input" lay-verify="required" placeholder="请输入API私钥" value="">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">API令牌</label>
            <div class="layui-input-block">
                <input type="text" name="api_token" class="layui-input" lay-verify="required" placeholder="请输入API令牌" value="">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">状态</label>
            <div class="layui-input-block">
                <input type="radio" name="status" value="1" title="禁用">
                <input type="radio" name="status" value="2" title="启用" checked>
                <div class="layui-form-mid layui-word-aux">状态会根据VIP时间自动调整</div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">排序</label>
            <div class="layui-input-block">
                <input type="number" name="sort" class="layui-input" lay-affix="number"  placeholder="请输入排序" value="0">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">最后登录时间</label>
            <div class="layui-input-block">
                <input type="text" name="last_login_time" class="layui-input" readonly placeholder="最后登录时间" value="">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">最后登录IP</label>
            <div class="layui-input-block">
                <input type="text" name="last_login_ip" class="layui-input" readonly placeholder="最后登录IP" value="">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">日卡消费</label>
            <div class="layui-input-block">
                <input type="number" name="carday_consumption" class="layui-input" min="0" step="1" placeholder="请输入日卡消费" value="0">
                <div class="layui-form-mid layui-word-aux">消费次数，每次+1递增</div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">周卡消费</label>
            <div class="layui-input-block">
                <input type="number" name="carweek_consumption" class="layui-input" min="0" step="1" placeholder="请输入周卡消费" value="0">
                <div class="layui-form-mid layui-word-aux">消费次数，每次+1递增</div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">月卡消费</label>
            <div class="layui-input-block">
                <input type="number" name="carmonth_consumption" class="layui-input" min="0" step="1" placeholder="请输入月卡消费" value="0">
                <div class="layui-form-mid layui-word-aux">消费次数，每次+1递增</div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">VIP权限</label>
            <div class="layui-input-block">
                <input type="text" name="vip_function" class="layui-input" placeholder="请输入VIP权限" value="1">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">VIP状态</label>
            <div class="layui-input-block">
                <input type="radio" name="vip_status" value="1" title="开通VIP" lay-filter="vip_status" checked>
                <input type="radio" name="vip_status" value="0" title="未开通" lay-filter="vip_status">
                <div style="margin-top: 10px;">
                    <input type="text" name="vip_off_time" class="layui-input" id="vip_off_time" lay-verify="required" placeholder="请选择VIP到期时间" value="">
                </div>
                <div class="layui-form-mid layui-word-aux">VIP过期后用户状态将自动设置为禁用</div>
            </div>
        </div>
        <div class="hr-line"></div>
        <div class="layui-form-item text-center">
            <button type="submit" class="layui-btn layui-btn-normal layui-btn-sm" lay-submit>确认</button>
            <button type="reset" class="layui-btn layui-btn-primary layui-btn-sm">重置</button>
        </div>
    </form>
</div>

<script>
layui.use(['form', 'laydate'], function(){
    var form = layui.form;
    var laydate = layui.laydate;
    
    // 设置VIP时间默认值为当前时间+30天
    var now = new Date();
    now.setDate(now.getDate() + 30);
    var defaultVipTime = now.getFullYear() + '-' + 
                        String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(now.getDate()).padStart(2, '0') + ' ' + 
                        String(now.getHours()).padStart(2, '0') + ':' + 
                        String(now.getMinutes()).padStart(2, '0') + ':00';
    
    // 设置VIP时间输入框的默认值
    document.getElementById('vip_off_time').value = defaultVipTime;
    
    // 初始化VIP时间日期时间选择器
    laydate.render({
        elem: '#vip_off_time',
        type: 'datetime',
        format: 'yyyy-MM-dd HH:mm:ss',
        min: 0, // 不允许选择过去的时间
        value: defaultVipTime
    });
    
    // VIP状态切换处理
    form.on('radio(vip_status)', function(data){
        var vipOffTimeInput = document.getElementById('vip_off_time');
        if (data.value == '0') {
            // 选择"未开通"时，禁用VIP时间输入框并清空值
            vipOffTimeInput.disabled = true;
            vipOffTimeInput.value = '';
        } else {
            // 选择"开通VIP"时，启用VIP时间输入框
            vipOffTimeInput.disabled = false;
            // 如果当前没有设置时间，默认设置为当前时间+30天
            if (!vipOffTimeInput.value) {
                var now = new Date();
                now.setDate(now.getDate() + 30);
                vipOffTimeInput.value = now.getFullYear() + '-' + 
                    String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(now.getDate()).padStart(2, '0') + ' ' + 
                    String(now.getHours()).padStart(2, '0') + ':' + 
                    String(now.getMinutes()).padStart(2, '0') + ':00';
            }
        }
    });
    
    // 表单提交处理
    form.on('submit', function(data){
        // 表单验证
        if (!validateForm(data.field)) {
            return false;
        }
        
        // 如果选择未开通VIP，清空VIP时间字段
        if (data.field.vip_status == '0') {
            data.field.vip_off_time = '';
        }
        
        var loadIndex = layer.load(2, {shade:[0.3, '#333']});
        $.ajax({
            url: "{:url('add')}",
            dataType: 'json',
            data: data.field,
            success: function (data) {
                layer.close(loadIndex);
                if (data.code == 1) {
                    layer.msg(data.msg, {icon: 1, time: 1000}, function () {
                        // 关闭弹层并刷新父页面
                        var iframeIndex = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(iframeIndex);
                        parent.layui.table.reload("currentTableId");
                    });
                } else {
                    layer.msg(data.msg, {icon: 2, time: 2000});
                }
            },
            error: function(xhr, status, error) {
                layer.close(loadIndex);
                layer.msg('网络错误，请稍后重试', {icon: 2, time: 2000});
            }
        });
        return false;
    });
    
    // 表单验证函数
    function validateForm(field) {
        // 验证用户名
        if (field.username.length < 2 || field.username.length > 20) {
            layer.msg('用户名长度应在2-20位之间', {icon: 2, time: 2000});
            return false;
        }
        
        // 验证密码
        if (field.password.length < 6 || field.password.length > 20) {
            layer.msg('密码长度应在6-20位之间', {icon: 2, time: 2000});
            return false;
        }
        
        // 验证窗口数量
        if (field.allow_window < 1 || field.allow_window > 100) {
            layer.msg('窗口数量应在1-100之间', {icon: 2, time: 2000});
            return false;
        }
        
        // 验证VIP时间
        if (field.vip_status == '1' && !field.vip_off_time) {
            layer.msg('请选择VIP到期时间', {icon: 2, time: 2000});
            return false;
        }
        
        return true;
    }
});
</script>