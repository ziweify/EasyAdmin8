<![CDATA[<div class="layuimini-container">
    <div class="layuimini-main">
        <form id="app-form" class="layui-form layuimini-form">
            
            <div class="layui-form-item">
                <label class="layui-form-label">开奖数据</label>
                <div class="layui-input-block">
                    <textarea name="rawData" class="layui-textarea" style="height: 300px;" placeholder="请输入开奖数据，每行格式：期号,&quot;开奖号码&quot;,开奖时间&#13;&#10;例如：&#13;&#10;1000,&quot;01,02,03,04,05,06&quot;,&quot;&quot;"></textarea>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button type="button" class="layui-btn layui-btn-normal" id="parseData">解析数据</button>
                </div>
            </div>

            <fieldset class="layui-elem-field" style="margin-top: 30px;">
                <legend>解析结果</legend>
                <div class="layui-field-box">
                    <table id="parseTable" lay-filter="parseTable"></table>
                    
                    <div class="layui-form-item" style="margin-top: 20px;">
                        <div class="layui-input-block">
                            <button type="button" class="layui-btn layui-btn-normal" id="confirmImport" style="display:none;">确认导入</button>
                        </div>
                    </div>
                </div>
            </fieldset>

        </form>
    </div>
</div>

<script>
layui.use(['form', 'table', 'layer'], function () {
    var $ = layui.jquery;
    var form = layui.form;
    var table = layui.table;
    var layer = layui.layer;
    
    // 解析数据表格实例
    var parseTableIns;
    
    // 初始化解析表格
    parseTableIns = table.render({
        elem: '#parseTable',
        data: [],
        page: false,
        cols: [[
            {field: 'issueid', title: '期号', width: 120},
            {field: 'open_data', title: '开奖数据', width: 180},
            {field: 'p1', title: 'P1', width: 80},
            {field: 'p2', title: 'P2', width: 80},
            {field: 'p3', title: 'P3', width: 80},
            {field: 'p4', title: 'P4', width: 80},
            {field: 'p5', title: 'P5', width: 80},
            {field: 'open_time', title: '开奖时间', width: 180, templet: function(d){
                return d.open_time ? layui.util.toDateString(d.open_time * 1000, 'yyyy-MM-dd HH:mm:ss') : '';
            }}
        ]]
    });
    
    // 解析数据按钮点击事件
    $('#parseData').click(function(){
        var rawData = $('textarea[name="rawData"]').val();
        if(!rawData){
            layer.msg('请输入开奖数据', {icon: 2});
            return;
        }
        
        // 发送到后端解析
        $.ajax({
            url: window.location.href,
            type: 'POST',
            data: {
                action: 'parse',
                rawData: rawData
            },
            dataType: 'json',
            success: function(res){
                console.log('Parse response:', res); // 调试日志
                if(res.code == 1){
                    // 更新表格数据
                    parseTableIns.reload({
                        data: res.data
                    });
                    // 显示确认导入按钮
                    $('#confirmImport').show();
                }else{
                    layer.msg(res.msg || '解析失败', {icon: 2});
                }
            },
            error: function(xhr, status, error) {
                console.error('Parse error:', {xhr: xhr, status: status, error: error}); // 调试日志
                layer.msg('请求失败：' + error, {icon: 2});
            }
        });
    });
    
    // 确认导入按钮点击事件
    $('#confirmImport').click(function(){
        var loadIndex = layer.load(2);
        var tableData = parseTableIns.getData();
        
        $.ajax({
            url: window.location.href,
            type: 'POST',
            data: {
                action: 'import',
                data: JSON.stringify(tableData)
            },
            dataType: 'json',
            success: function(res){
                layer.close(loadIndex);
                if(res.code == 1){
                    layer.msg(res.msg, {icon: 1, time: 1000}, function(){
                        var iframeIndex = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(iframeIndex);
                        parent.layui.table.reload("currentTableId");
                    });
                }else{
                    layer.msg(res.msg, {icon: 2});
                }
            }
        });
    });
});
</script>]]>