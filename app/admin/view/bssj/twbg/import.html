<![CDATA[<div class="layuimini-container">
    <div class="layuimini-main">
        <form id="app-form" class="layui-form layuimini-form">
            
            <div class="layui-form-item">
                <label class="layui-form-label">开奖数据</label>
                <div class="layui-input-block">
                    <textarea name="rawData" class="layui-textarea" style="height: 300px;" placeholder="请输入开奖数据，每行格式：期号,&quot;开奖号码&quot;,开奖时间&#13;&#10;例如：&#13;&#10;1000,&quot;01,02,03,04,05,06&quot;,&quot;&quot;"></textarea>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button type="button" class="layui-btn layui-btn-normal" id="parseData">解析数据</button>
                </div>
            </div>

            <fieldset class="layui-elem-field" style="margin-top: 30px;">
                <legend>解析结果</legend>
                <div class="layui-field-box">
                    <table id="parseTable" lay-filter="parseTable"></table>
                    
                    <div class="layui-form-item" style="margin-top: 20px;">
                        <div class="layui-input-block">
                            <button type="button" class="layui-btn layui-btn-normal" id="confirmImport" style="display:none;">确认导入</button>
                        </div>
                    </div>
                </div>
            </fieldset>

        </form>
    </div>
</div>

<script>
layui.use(['form', 'table', 'layer', 'util'], function () {
    var $ = layui.jquery;
    var form = layui.form;
    var table = layui.table;
    var layer = layui.layer;
    var util = layui.util;
    
    // 初始化解析表格
    var parseTable = table.render({
        elem: '#parseTable',
        id: 'parseTable',
        data: [],
        page: false,
        cols: [[
            {field: 'issueid', title: '期号', width: 120},
            {field: 'open_data', title: '开奖数据', width: 180},
            {field: 'p1', title: 'P1', width: 80},
            {field: 'p2', title: 'P2', width: 80},
            {field: 'p3', title: 'P3', width: 80},
            {field: 'p4', title: 'P4', width: 80},
            {field: 'p5', title: 'P5', width: 80},
            {field: 'open_time', title: '开奖时间', width: 180, templet: function(d){
                return d.open_time ? layui.util.toDateString(d.open_time * 1000, 'yyyy-MM-dd HH:mm:ss') : '';
            }},
            {field: 'import_status', title: '导入状态', width: 120, templet: function(d){
                if(!d.import_status) return '';
                var statusClass = {
                    'success': 'layui-bg-green',
                    'exists': 'layui-bg-orange',
                    'failed': 'layui-bg-red'
                };
                var statusText = {
                    'success': '成功',
                    'exists': '已存在',
                    'failed': '失败'
                };
                return '<span class="layui-badge ' + (statusClass[d.import_status] || '') + '">' + 
                       (statusText[d.import_status] || d.import_status) + 
                       (d.error_msg ? ': ' + d.error_msg : '') + '</span>';
            }}
        ]]
    });
    
    // 解析数据按钮点击事件
    $('#parseData').click(function(){
        var rawData = $('textarea[name="rawData"]').val();
        if(!rawData){
            layer.msg('请输入开奖数据', {icon: 2});
            return;
        }
        
        // 获取当前表格数据
        var currentData = table.cache['parseTable'] || [];
        
        // 发送到后端解析
        $.ajax({
            url: window.location.href,
            type: 'POST',
            data: {
                action: 'parse',
                rawData: rawData,
                existingData: JSON.stringify(currentData)
            },
            dataType: 'json',
            success: function(res){
                console.log('Parse response:', res); // 调试日志
                if(res.code == 1){
                    // 更新表格数据
                    table.reload('parseTable', {
                        data: res.data
                    });
                    // 显示确认导入按钮
                    $('#confirmImport').show();
                }else{
                    layer.msg(res.msg || '解析失败', {icon: 2});
                }
            },
            error: function(xhr, status, error) {
                console.error('Parse error:', {xhr: xhr, status: status, error: error}); // 调试日志
                layer.msg('请求失败：' + error, {icon: 2});
            }
        });
    });
    
    // 确认导入按钮点击事件
    $('#confirmImport').click(function(){
        var loadIndex = layer.load(2);
        
        // 获取当前表格数据
        var tableData = table.cache['parseTable'] || [];
        
        // 过滤掉已经成功导入的数据
        var dataToImport = tableData.filter(function(item) {
            return !item.import_status || item.import_status !== 'success';
        });
        
        if(dataToImport.length === 0) {
            layer.close(loadIndex);
            layer.msg('没有新数据需要导入', {icon: 0});
            return;
        }
        
        $.ajax({
            url: window.location.href,
            type: 'POST',
            data: {
                action: 'import',
                data: JSON.stringify(dataToImport)
            },
            dataType: 'json',
            success: function(res){
                layer.close(loadIndex);
                if(res.code == 1){
                    // 更新表格中的导入状态
                    var newData = tableData.map(function(item) {
                        var result = res.data.find(r => r.issueid === item.issueid);
                        if(result) {
                            return {
                                ...item,
                                import_status: result.status,
                                error_msg: result.error_msg
                            };
                        }
                        return item;
                    });
                    
                    // 更新表格
                    table.reload('parseTable', {
                        data: newData
                    });
                    
                    // 显示成功消息
                    layer.msg(res.msg, {icon: 1});
                    
                    // 如果全部导入成功，则关闭窗口并刷新父页面
                    var allSuccess = newData.every(item => item.import_status === 'success');
                    if(allSuccess) {
                        setTimeout(function(){
                            var iframeIndex = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(iframeIndex);
                            parent.layui.table.reload("currentTableId");
                        }, 1000);
                    }
                }else{
                    layer.msg(res.msg, {icon: 2});
                }
            },
            error: function(xhr, status, error) {
                layer.close(loadIndex);
                console.error('导入错误：', {
                    status: status,
                    error: error,
                    response: xhr.responseText
                });
                
                let errorMsg = '请求失败';
                try {
                    // 尝试解析错误响应
                    const response = JSON.parse(xhr.responseText);
                    errorMsg = response.msg || response.message || error;
                } catch (e) {
                    errorMsg = xhr.responseText || error;
                }
                
                layer.msg('导入失败：' + errorMsg, {
                    icon: 2,
                    time: 0,  // 不自动关闭
                    btn: ['确定']
                });
            }
        });
    });
});
</script>]]>